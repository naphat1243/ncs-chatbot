# ЁЯЦ╝я╕П Image Size Issue Fix

## ЁЯРЫ **р╕Ыр╕▒р╕Нр╕лр╕▓р╕Чр╕╡р╣Ир╕Юр╕Ъ:**

```
2025/10/05 14:34:34 ЁЯУм Message sent to thread. Response status: 400
тЪая╕П Non-200 response body: {
  "error": {
    "message": "Invalid 'content[1].image_url.url'. Expected a valid URL, but got a value with an invalid format.",
    "type": "invalid_request_error",
    "param": "content",
    "code": "invalid_value"
  }
}
```

**р╕кр╕▓р╣Ар╕лр╕Хр╕╕**: р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕бр╕╡р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Др╕Ы (795,495 characters) р╕Чр╕│р╣Гр╕лр╣Й OpenAI API р╣Др╕бр╣Ир╕вр╕нр╕бр╕гр╕▒р╕Ъ data URL

## тЬЕ **р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В:**

### 1. **р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╕Щр╕▓р╕Фр╣Др╕Яр╕ер╣Мр╕Хр╣Йр╕Щр╕Чр╕▓р╕З (р╣Гр╕Щ getLineImageURL)**
```go
// Check if image is too large for OpenAI API (limit ~20MB for data URLs)
const maxImageSize = 20 * 1024 * 1024 // 20MB
if len(imageData) > maxImageSize {
    log.Printf("тЪая╕П Image too large (%d bytes > %d bytes). Attempting to resize...", len(imageData), maxImageSize)
    return "", fmt.Errorf("р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕бр╕╡р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Др╕Ы р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕Фр╕Вр╕Щр╕▓р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Бр╕ер╣Йр╕зр╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З")
}
```

### 2. **р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╕Щр╕▓р╕Ф Data URL р╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в**
```go
// Check final data URL length (OpenAI has limits on data URL size)
const maxDataURLLength = 1000000 // ~1MB base64 encoded
if len(dataURL) > maxDataURLLength {
    log.Printf("тЪая╕П Data URL too long (%d chars > %d chars)", len(dataURL), maxDataURLLength)
    return "", fmt.Errorf("р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕бр╕╡р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Др╕Ы р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕Фр╕Вр╕Щр╕▓р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Бр╕ер╣Йр╕зр╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З")
}
```

### 3. **р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╣Ир╕нр╕Щр╕кр╣Ир╕Зр╣Др╕Ы OpenAI (р╣Гр╕Щ getAssistantResponse)**
```go
// Check if image data URL is too large for OpenAI API
const maxDataURLLength = 1000000 // ~1MB base64 encoded
if len(imageURL) > maxDataURLLength {
    log.Printf("тЪая╕П Data URL too long (%d chars > %d chars) - rejecting", len(imageURL), maxDataURLLength)
    return "р╕Вр╕нр╕нр╕ар╕▒р╕в р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕бр╕╡р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Др╕Ы р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕Фр╕Вр╕Щр╕▓р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕лр╕гр╕╖р╕нр╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Гр╕лр╕бр╣Ир╣Гр╕лр╣Йр╣Ар╕ер╣Зр╕Бр╕Бр╕зр╣Ир╕▓р╕Щр╕╡р╣Йр╣Бр╕ер╣Йр╕зр╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Др╣Ир╕░ ЁЯУ╕"
}
```

## ЁЯОп **р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:**

### **р╣Ар╕бр╕╖р╣Ир╕нр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Др╕Ы р╕гр╕░р╕Ър╕Ър╕Ир╕░:**
1. тЪая╕П р╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕Чр╕╡р╣Ир╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╕Ир╕▓р╕Б LINE
2. ЁЯУП р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╕Щр╕▓р╕Ф Data URL р╕Бр╣Ир╕нр╕Щр╕кр╣Ир╕Зр╣Др╕Ы OpenAI  
3. ЁЯТм р╕Хр╕нр╕Ър╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Фр╣Йр╕зр╕вр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕бр╕┤р╕Хр╕г
4. ЁЯУ╕ р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Гр╕лр╕бр╣Ир╕лр╕гр╕╖р╕нр╕ер╕Фр╕Вр╕Щр╕▓р╕Ф

### **р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Ир╕░р╣Ар╕лр╣Зр╕Щ:**
```
"р╕Вр╕нр╕нр╕ар╕▒р╕в р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕бр╕╡р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╣Др╕Ы р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕Фр╕Вр╕Щр╕▓р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕лр╕гр╕╖р╕нр╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Гр╕лр╕бр╣Ир╣Гр╕лр╣Йр╣Ар╕ер╣Зр╕Бр╕Бр╕зр╣Ир╕▓р╕Щр╕╡р╣Йр╣Бр╕ер╣Йр╕зр╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Др╣Ир╕░ ЁЯУ╕"
```

### **Log р╕Чр╕╡р╣Ир╕Ир╕░р╣Ар╕лр╣Зр╕Щ:**
```
тЪая╕П Data URL too long (795495 chars > 1000000 chars) - rejecting
```

## ЁЯУК **р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф:**

| р╕Ыр╕гр╕░р╣Ар╕ар╕Ч | р╕Вр╕╡р╕Фр╕Ир╕│р╕Бр╕▒р╕Ф | р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕ |
|--------|----------|----------|
| **р╣Др╕Яр╕ер╣Мр╕Хр╣Йр╕Щр╕Чр╕▓р╕З** | 20MB | р╣Др╕Яр╕ер╣Мр╕ар╕▓р╕Юр╕Фр╕┤р╕Ър╕Ир╕▓р╕Б LINE |
| **Data URL** | 1MB | Base64 encoded р╕кр╕│р╕лр╕гр╕▒р╕Ъ OpenAI |
| **Characters** | ~1,000,000 | р╕Др╕зр╕▓р╕бр╕вр╕▓р╕з string р╕Вр╕нр╕З data URL |

## ЁЯЪА **р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ:**

1. **р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Ыр╕Бр╕Хр╕┤** (< 1MB) тЖТ тЬЕ р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Фр╣Йр╕Ыр╕Бр╕Хр╕┤
2. **р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Гр╕лр╕Нр╣И** (> 1MB) тЖТ тЪая╕П р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Гр╕лр╣Йр╕ер╕Фр╕Вр╕Щр╕▓р╕Ф
3. **р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Гр╕лр╕Нр╣Ир╕бр╕▓р╕Б** (> 20MB) тЖТ тЭМ р╕Ыр╕Пр╕┤р╣Ар╕кр╕Шр╕Чр╕▒р╕Щр╕Чр╕╡

## ЁЯТб **р╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Гр╕Щр╕нр╕Щр╕▓р╕Др╕Х:**

1. **Image Compression** - р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Ър╕╡р╕Ър╕нр╕▒р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
2. **Image Resizing** - р╕ер╕Фр╕Вр╕Щр╕▓р╕Фр╕Др╕зр╕▓р╕бр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤  
3. **Format Conversion** - р╣Бр╕Ыр╕ер╕Зр╣Ар╕Ыр╣Зр╕Щ WebP р╣Ар╕Юр╕╖р╣Ир╕нр╕ер╕Фр╕Вр╕Щр╕▓р╕Ф
4. **Progressive Upload** - р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕Чр╕╡р╕ер╕░р╕кр╣Ир╕зр╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕╣р╕Ыр╣Гр╕лр╕Нр╣И

---

*р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕гр╕░р╕Ър╕Ър╕Ир╕░р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣Ир╣Др╕Фр╣Йр╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕лр╕бр╕▓р╕░р╕кр╕б р╣Вр╕Фр╕вр╣Др╕бр╣Ир╣Гр╕лр╣Йр╣Ар╕Бр╕┤р╕Ф error 400 р╕Ир╕▓р╕Б OpenAI API р╕нр╕╡р╕Бр╕Хр╣Ир╕нр╣Др╕Ы!* ЁЯОЙ